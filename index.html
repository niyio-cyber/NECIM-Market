<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NECMIS - Market Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Login */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .login-overlay.hidden { display: none; }
        .login-box {
            background: #1e2a3a; padding: 40px; border-radius: 16px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-box h2 { color: #4da6ff; margin-bottom: 10px; }
        .login-box p { color: #888; margin-bottom: 20px; font-size: 0.9em; }
        .login-box input {
            padding: 12px 20px; border: 2px solid #333; border-radius: 8px;
            background: #0d1520; color: #fff; font-size: 1em; width: 250px;
            margin-bottom: 15px;
        }
        .login-box button {
            padding: 12px 30px; background: linear-gradient(135deg, #4da6ff, #2d7dd2);
            border: none; border-radius: 8px; color: white; font-weight: 600;
            cursor: pointer; font-size: 1em;
        }
        .login-error { color: #ff6b6b; margin-top: 10px; font-size: 0.9em; }
        .login-error.hidden { display: none; }
        
        /* Header */
        .header {
            background: rgba(30, 42, 58, 0.95); border-radius: 16px;
            padding: 25px; margin-bottom: 25px;
            border: 1px solid rgba(77, 166, 255, 0.2);
        }
        .header h1 { color: #4da6ff; font-size: 1.8em; margin-bottom: 5px; }
        .header .subtitle { color: #888; font-size: 0.95em; }
        .header .date { color: #4da6ff; font-weight: 600; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: rgba(30, 42, 58, 0.9); border-radius: 12px; padding: 20px;
            text-align: center; border: 1px solid rgba(77, 166, 255, 0.15);
        }
        .stat-card .value { font-size: 1.8em; font-weight: 700; color: #4da6ff; }
        .stat-card .label { font-size: 0.85em; color: #888; margin-top: 5px; }
        
        /* Market Health */
        .market-health {
            background: rgba(30, 42, 58, 0.95); border-radius: 16px;
            padding: 25px; margin-bottom: 25px;
            border: 1px solid rgba(77, 166, 255, 0.2);
        }
        .section-title { color: #4da6ff; font-size: 1.3em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .section-subtitle { color: #666; font-size: 0.85em; margin-bottom: 20px; }
        .overall-score {
            text-align: center; padding: 20px; background: rgba(77, 166, 255, 0.1);
            border-radius: 12px; margin-bottom: 20px;
        }
        .overall-score .score { font-size: 3em; font-weight: 700; color: #4da6ff; }
        .overall-score .status { font-size: 1.1em; color: #888; margin-top: 5px; }
        .overall-score .guidance { font-size: 0.85em; color: #666; margin-top: 10px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .metric-card {
            background: rgba(13, 21, 32, 0.8); border-radius: 10px; padding: 15px;
            border-left: 4px solid #4da6ff;
        }
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-name { font-weight: 600; color: #e0e0e0; font-size: 0.95em; }
        .metric-score { font-size: 1.2em; font-weight: 700; }
        .metric-trend { font-size: 0.9em; }
        .metric-raw { font-size: 0.8em; color: #666; margin-top: 4px; }
        .trend-up { color: #4ade80; }
        .trend-down { color: #f87171; }
        .trend-stable { color: #fbbf24; }
        .metric-action { font-size: 0.85em; color: #888; }
        
        /* Feed */
        .feed-section {
            background: rgba(30, 42, 58, 0.95); border-radius: 16px;
            padding: 25px; margin-bottom: 25px;
            border: 1px solid rgba(77, 166, 255, 0.2);
        }
        
        /* STATE FILTER - NEW */
        .state-filters {
            display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;
            padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .state-filter {
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            background: rgba(13, 21, 32, 0.8); color: #888; border: 1px solid transparent;
            font-size: 0.85em; font-weight: 600; transition: all 0.2s;
        }
        .state-filter:hover { color: #4da6ff; border-color: rgba(77, 166, 255, 0.3); }
        .state-filter.active { 
            background: rgba(77, 166, 255, 0.2); color: #4da6ff; 
            border-color: #4da6ff; 
        }
        .state-filter .count {
            display: inline-block; margin-left: 6px; padding: 2px 6px;
            background: rgba(0,0,0,0.3); border-radius: 10px; font-size: 0.8em;
        }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab {
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            background: rgba(13, 21, 32, 0.8); color: #888; border: 1px solid transparent;
            font-size: 0.9em; transition: all 0.2s;
        }
        .tab:hover { color: #4da6ff; }
        .tab.active { background: rgba(77, 166, 255, 0.2); color: #4da6ff; border-color: #4da6ff; }
        .feed-content { display: none; }
        .feed-content.active { display: block; }
        
        /* Project Cards - Refined */
        .project-card {
            background: rgba(13, 21, 32, 0.9); border-radius: 12px; padding: 18px;
            margin-bottom: 12px; border-left: 4px solid #4da6ff;
            transition: all 0.2s;
        }
        .project-card:hover { transform: translateX(5px); border-left-color: #2dd4bf; }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .project-location { 
            font-size: 1.1em; font-weight: 700; color: #4da6ff;
            display: flex; align-items: center; gap: 8px;
        }
        .project-value {
            font-size: 1.3em; font-weight: 700; color: #2dd4bf;
            white-space: nowrap;
        }
        .project-name {
            font-size: 0.95em; color: #e0e0e0; line-height: 1.5;
            margin-bottom: 10px;
        }
        .project-meta {
            display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.85em; color: #888;
            margin-bottom: 10px;
        }
        .project-meta span { display: flex; align-items: center; gap: 5px; }
        .project-type {
            display: inline-block; padding: 4px 10px; border-radius: 6px;
            font-size: 0.8em; font-weight: 600; margin-right: 8px;
            background: rgba(77, 166, 255, 0.15); color: #4da6ff;
        }
        .project-type.bridge { background: rgba(77, 166, 255, 0.15); color: #4da6ff; }
        .project-type.pavement { background: rgba(80, 200, 120, 0.15); color: #50c878; }
        .project-type.safety { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; }
        .project-type.other { background: rgba(155, 89, 182, 0.15); color: #9b59b6; }
        .project-link {
            display: inline-block; padding: 6px 14px; border-radius: 6px;
            font-size: 0.85em; text-decoration: none;
            background: rgba(77, 166, 255, 0.2); color: #4da6ff;
        }
        .project-link:hover { background: rgba(77, 166, 255, 0.3); }
        
        /* News Cards */
        .news-card {
            background: rgba(13, 21, 32, 0.9); border-radius: 12px; padding: 18px;
            margin-bottom: 12px; border-left: 4px solid #a78bfa;
        }
        .news-card.funding { border-left-color: #2dd4bf; }
        .news-source { font-size: 0.85em; color: #888; margin-bottom: 5px; }
        .news-title { font-size: 1em; color: #e0e0e0; margin-bottom: 8px; line-height: 1.4; }
        .news-summary { font-size: 0.9em; color: #888; line-height: 1.5; }
        
        /* Sidebar */
        .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 25px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        .sidebar-widget {
            background: rgba(30, 42, 58, 0.95); border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(77, 166, 255, 0.15);
        }
        .widget-title { font-size: 1em; color: #4da6ff; margin-bottom: 15px; }
        .state-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .state-item:last-child { border-bottom: none; }
        .state-item:hover { color: #4da6ff; }
        .state-item.active { color: #4da6ff; font-weight: 600; }
        .portal-link {
            display: block; padding: 10px; margin-bottom: 8px; border-radius: 8px;
            background: rgba(13, 21, 32, 0.8); text-decoration: none;
            color: #888; font-size: 0.85em; transition: all 0.2s;
        }
        .portal-link:hover { background: rgba(77, 166, 255, 0.1); color: #4da6ff; }
        .portal-link strong { color: #e0e0e0; display: block; margin-bottom: 3px; }
        
        /* Pipeline Analysis (Phase 8.1) */
        .pipeline-analysis {
            background: rgba(30, 42, 58, 0.95);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(77, 166, 255, 0.15);
        }
        .pipeline-analysis .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .pipeline-analysis .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #4da6ff;
            margin-bottom: 5px;
        }
        .pipeline-analysis .section-subtitle {
            font-size: 0.85em;
            color: #888;
        }
        .chart-controls select {
            background: rgba(13, 21, 32, 0.9);
            border: 1px solid rgba(77, 166, 255, 0.3);
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 140px;
        }
        .chart-controls select:hover {
            border-color: #4da6ff;
        }
        .chart-controls select:focus {
            outline: none;
            border-color: #4da6ff;
            box-shadow: 0 0 0 2px rgba(77, 166, 255, 0.2);
        }
        .pipeline-content {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 25px;
        }
        .chart-container {
            background: rgba(13, 21, 32, 0.5);
            border-radius: 12px;
            padding: 20px;
            min-height: 320px;
        }
        .pipeline-summary {
            background: rgba(13, 21, 32, 0.5);
            border-radius: 12px;
            padding: 20px;
        }
        .summary-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .type-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .type-row:last-child { border-bottom: none; }
        .type-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #ccc;
        }
        .type-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .type-value {
            font-weight: 600;
            color: #e0e0e0;
            font-size: 0.9em;
        }
        .type-pct {
            font-size: 0.8em;
            color: #888;
            margin-left: 5px;
        }
        .pipeline-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(77, 166, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pipeline-total .label {
            font-size: 0.95em;
            color: #888;
        }
        .pipeline-total .value {
            font-size: 1.4em;
            font-weight: 700;
            color: #4da6ff;
        }
        @media (max-width: 900px) {
            .pipeline-content {
                grid-template-columns: 1fr;
            }
            .pipeline-summary {
                order: -1;
            }
        }
        
        /* Footer */
        .footer { text-align: center; padding: 20px; color: #666; font-size: 0.85em; }
    </style>
</head>
<body>
    <!-- Login -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2>üîê NECMIS Access</h2>
            <p>Northeast Construction Market Intelligence System</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')checkPassword()">
            <br>
            <button onclick="checkPassword()">Access Dashboard</button>
            <div class="login-error hidden" id="loginError">Incorrect password. Please try again.</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä NECMIS - Market Intelligence</h1>
            <p class="subtitle">
                <span class="date" id="currentDate"></span><br>
                Northeast Construction Market Intelligence System | VT ‚Ä¢ NH ‚Ä¢ ME ‚Ä¢ MA ‚Ä¢ NY ‚Ä¢ RI ‚Ä¢ CT ‚Ä¢ PA
            </p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card"><div class="value" id="pipelineValue">--</div><div class="label">Pipeline Value</div></div>
            <div class="stat-card"><div class="value" id="totalOpportunities">--</div><div class="label">Total Opportunities</div></div>
            <div class="stat-card"><div class="value" id="dotLettings">--</div><div class="label">DOT Lettings</div></div>
            <div class="stat-card"><div class="value" id="fundingCount">--</div><div class="label">Funding</div></div>
            <div class="stat-card"><div class="value" id="newsCount">--</div><div class="label">News</div></div>
            <div class="stat-card"><div class="value" id="totalItems">--</div><div class="label">Total Items</div></div>
        </div>

        <!-- Market Health -->
        <div class="market-health">
            <div class="section-title">üìà Market Health Framework</div>
            <div class="section-subtitle">7 Public Metrics | Real-Time API Data | Scores + Trends + Actions</div>
            <div class="overall-score">
                <div class="score" id="overallScore">--</div>
                <div class="status" id="overallStatus">Loading...</div>
                <div class="guidance" id="overallGuidance"></div>
            </div>
            <div class="metrics-grid" id="metricsGrid"></div>
        </div>

        <!-- Pipeline Analysis (Phase 8.1) -->
        <div class="pipeline-analysis">
            <div class="section-header">
                <div>
                    <div class="section-title">üìä Pipeline by Project Type</div>
                    <div class="section-subtitle">Fiscal Year Analysis | Stacked by Type | YoY Growth Trend</div>
                </div>
                <div class="chart-controls">
                    <select id="pipelineStateFilter" onchange="updatePipelineChart()">
                        <option value="all">All States</option>
                    </select>
                </div>
            </div>
            
            <div class="pipeline-content">
                <div class="chart-container">
                    <canvas id="pipelineChart"></canvas>
                </div>
                <div class="pipeline-summary">
                    <div class="summary-title">Pipeline Breakdown</div>
                    <div id="pipelineTypeSummary"></div>
                    <div class="pipeline-total" id="pipelineTotalDisplay">
                        <span class="label">Total Pipeline</span>
                        <span class="value">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <div class="feed-section">
                <div class="section-title">üìã Intelligence Feed</div>
                
                <!-- STATE FILTERS - NEW -->
                <div class="state-filters" id="stateFilters"></div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="dot">üèóÔ∏è DOT Lettings</div>
                    <div class="tab" data-tab="news">üì∞ News</div>
                    <div class="tab" data-tab="funding">üíµ Funding</div>
                    <div class="tab" data-tab="all">All</div>
                </div>
                <div class="feed-content active" id="dot-content"></div>
                <div class="feed-content" id="news-content"></div>
                <div class="feed-content" id="funding-content"></div>
                <div class="feed-content" id="all-content"></div>
            </div>

            <div class="sidebar">
                <div class="sidebar-widget">
                    <div class="widget-title">üìä By State</div>
                    <div id="stateBreakdown"></div>
                </div>
                <div class="sidebar-widget">
                    <div class="widget-title">üîó DOT Bid Portals</div>
                    <div id="portalLinks"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <strong>NECMIS - Northeast Construction Market Intelligence System</strong><br>
            Data Sources: State DOT Portals (8 states) | Regional News RSS (10 feeds) | Market Health: FRED, EIA, Census APIs<br>
            Last Updated: <span id="lastUpdated">--</span>
        </div>
    </div>

    <!-- Chart.js for Pipeline Analysis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    
    <script>
        const PASSWORD = 'NECMIS2026!';
        const STATES = ['VT', 'NH', 'ME', 'MA', 'NY', 'RI', 'CT', 'PA'];
        const PORTALS = {
            'VT': { name: 'VTrans', desc: 'Construction Contracting', url: 'https://vtrans.vermont.gov/contract-admin/bids-requests/construction-contracting' },
            'NH': { name: 'NHDOT', desc: 'Invitation to Bid', url: 'https://www.dot.nh.gov/doing-business-nhdot/contractors/invitation-bid' },
            'ME': { name: 'MaineDOT', desc: 'Construction Advertisement Plan', url: 'https://www.maine.gov/dot/major-projects/cap' },
            'MA': { name: 'MassDOT', desc: 'Status Report', url: 'https://hwy.massdot.state.ma.us/webapps/const/statusReport.asp' },
            'NY': { name: 'NYSDOT', desc: 'Highway Construction', url: 'https://www.dot.ny.gov/doing-business/opportunities/const-highway' },
            'RI': { name: 'RIDOT', desc: 'Current Projects', url: 'https://www.dot.ri.gov/about/current_projects.php' },
            'CT': { name: 'CTDOT', desc: 'Contractor Information', url: 'https://portal.ct.gov/DOT/Doing-Business/Contractor-Information' },
            'PA': { name: 'PennDOT', desc: 'Letting Information', url: 'https://www.penndot.pa.gov/business/Letting/Pages/default.aspx' }
        };
        
        // Project type colors (4 categories: Bridge, Pavement, Safety, Other)
        const TYPE_COLORS = {
            'Bridge': '#4da6ff',      // Blue
            'Pavement': '#50c878',    // Green
            'Safety': '#ff6b6b',      // Red
            'Other': '#9b59b6'        // Purple
        };

        // Global state
        let currentData = null;
        let selectedState = 'all';
        let pipelineChart = null;

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === PASSWORD) {
                document.getElementById('loginOverlay').classList.add('hidden');
                localStorage.setItem('necmis_auth', 'true');
                loadData();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function init() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (localStorage.getItem('necmis_auth') === 'true') {
                document.getElementById('loginOverlay').classList.add('hidden');
                loadData();
            }
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.feed-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-content').classList.add('active');
                });
            });
            renderPortals();
        }

        function renderPortals() {
            const container = document.getElementById('portalLinks');
            container.innerHTML = Object.entries(PORTALS).map(([state, info]) =>
                `<a href="${info.url}" target="_blank" class="portal-link"><strong>${state} - ${info.name}</strong>${info.desc}</a>`
            ).join('');
        }

        function formatCurrency(val) {
            if (!val) return '--';
            if (val >= 1e9) return '$' + (val/1e9).toFixed(1) + 'B';
            if (val >= 1e6) return '$' + (val/1e6).toFixed(1) + 'M';
            if (val >= 1e3) return '$' + (val/1e3).toFixed(0) + 'K';
            return '$' + val.toLocaleString();
        }

        function getProjectTypeClass(type) {
            if (!type) return '';
            const t = type.toLowerCase();
            if (t.includes('bridge') || t.includes('culvert')) return 'bridge';
            if (t.includes('safety') || t.includes('signal') || t.includes('guardrail') || t.includes('marking') || t.includes('intersection')) return 'safety';
            if (t.includes('transit') || t.includes('rail') || t.includes('bike') || t.includes('pedestrian') || t.includes('drainage') || t.includes('sidewalk')) return 'other';
            if (t.includes('pavement') || t.includes('surfacing') || t.includes('highway') || t.includes('reconstruction') || t.includes('hma') || t.includes('overlay')) return 'pavement';
            return 'pavement'; // Default: road work ‚Üí pavement
        }

        async function loadData() {
            try {
                const resp = await fetch('data/necmis_data.json?' + Date.now());
                const data = await resp.json();
                currentData = data;
                renderDashboard(data);
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function setStateFilter(state) {
            selectedState = state;
            // Update filter buttons
            document.querySelectorAll('.state-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.state === state);
            });
            // Update sidebar
            document.querySelectorAll('.state-item').forEach(item => {
                item.classList.toggle('active', item.dataset.state === state);
            });
            // Re-render with filter
            if (currentData) renderFeeds(currentData);
        }

        function renderDashboard(data) {
            // Stats - Use forward_pipeline (current FY + future) instead of total
            const forwardPipeline = data.summary?.forward_pipeline || data.summary?.total_value_low;
            document.getElementById('pipelineValue').textContent = formatCurrency(forwardPipeline);
            document.getElementById('totalOpportunities').textContent = data.summary?.total_opportunities || '--';
            document.getElementById('dotLettings').textContent = data.summary?.by_category?.dot_letting || '--';
            document.getElementById('fundingCount').textContent = data.summary?.by_category?.funding || '--';
            document.getElementById('newsCount').textContent = data.summary?.by_category?.news || '--';
            const total = (data.dot_lettings?.length || 0) + (data.news?.length || 0);
            document.getElementById('totalItems').textContent = total;
            document.getElementById('lastUpdated').textContent = data.generated ? new Date(data.generated).toLocaleString() : '--';

            // Market Health
            const mh = data.market_health || {};
            document.getElementById('overallScore').innerHTML = `${mh.overall_score || '--'}<span style="font-size:0.4em;color:#888">/10</span>`;
            document.getElementById('overallStatus').textContent = `Overall Market Health: ${(mh.overall_status || '').toUpperCase()}`;
            const guidance = {
                'growth': '7.5+ ‚Äî Aggressive expansion, invest in capacity',
                'stable': '6.0 - 7.5 ‚Äî Maintain position, selective investments',
                'watchlist': '< 6.0 ‚Äî Conservative mode, protect margins',
                'defensive': '< 5.0 ‚Äî Defensive mode, protect margins'
            };
            document.getElementById('overallGuidance').textContent = guidance[mh.overall_status] || '';

            // Updated metric labels with correct keys
            const metricLabels = {
                'dot_pipeline': 'DOT Project Pipeline (15%)',
                'housing_permits': 'Housing Permit Momentum (10%)',
                'construction_spending': 'Construction Spending (8%)',
                'construction_employment': 'Construction Employment (8%)',
                'migration': 'Migration Patterns (7%)',
                'input_cost': 'Input Cost Stability (7%)',
                'infrastructure_funding': 'Infrastructure Funding (5%)'
            };
            
            const metricsHtml = Object.entries(metricLabels).map(([key, label]) => {
                const m = mh[key] || {};
                const trendClass = m.trend === 'up' ? 'trend-up' : m.trend === 'down' ? 'trend-down' : 'trend-stable';
                const trendIcon = m.trend === 'up' ? '‚Üë' : m.trend === 'down' ? '‚Üì' : '‚Üí';
                const rawDisplay = m.raw_display || '';
                return `<div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-name">${label}</span>
                        <span class="metric-score ${trendClass}">${m.score || '--'}/10</span>
                    </div>
                    <div class="metric-trend ${trendClass}">${trendIcon} ${rawDisplay}</div>
                    <div class="metric-action">‚Üí ${m.action || '--'}</div>
                </div>`;
            }).join('');
            document.getElementById('metricsGrid').innerHTML = metricsHtml;

            // State filters
            const stateCounts = {};
            STATES.forEach(s => stateCounts[s] = 0);
            (data.dot_lettings || []).forEach(d => { if (stateCounts[d.state] !== undefined) stateCounts[d.state]++; });
            (data.news || []).forEach(n => { if (stateCounts[n.state] !== undefined) stateCounts[n.state]++; });
            
            const totalCount = Object.values(stateCounts).reduce((a,b) => a+b, 0);
            let filtersHtml = `<div class="state-filter ${selectedState === 'all' ? 'active' : ''}" data-state="all" onclick="setStateFilter('all')">All<span class="count">${totalCount}</span></div>`;
            STATES.forEach(s => {
                filtersHtml += `<div class="state-filter ${selectedState === s ? 'active' : ''}" data-state="${s}" onclick="setStateFilter('${s}')">${s}<span class="count">${stateCounts[s]}</span></div>`;
            });
            document.getElementById('stateFilters').innerHTML = filtersHtml;

            // State breakdown sidebar (clickable)
            const states = data.summary?.by_state || {};
            document.getElementById('stateBreakdown').innerHTML = Object.entries(states)
                .map(([s, c]) => `<div class="state-item ${selectedState === s ? 'active' : ''}" data-state="${s}" onclick="setStateFilter('${s}')"><span>${s}</span><span>${c}</span></div>`).join('');

            // Pipeline Analysis Chart (Phase 8.1)
            renderPipelineAnalysis(data);

            // Render feeds
            renderFeeds(data);
        }

        // Pipeline Analysis Chart Functions (Phase 8.1)
        function renderPipelineAnalysis(data) {
            const pa = data.summary?.pipeline_analysis;
            if (!pa) {
                console.warn('No pipeline_analysis in data');
                return;
            }

            // Populate state filter dropdown
            const stateSelect = document.getElementById('pipelineStateFilter');
            stateSelect.innerHTML = '<option value="all">All States</option>' +
                STATES.map(s => `<option value="${s}">${s}</option>`).join('');

            // Render chart with 'all' states
            updatePipelineChart();
        }

        function updatePipelineChart() {
            const pa = currentData?.summary?.pipeline_analysis;
            if (!pa) return;

            const selectedPipelineState = document.getElementById('pipelineStateFilter').value;
            
            // Get data based on selection
            let chartData;
            if (selectedPipelineState === 'all') {
                chartData = pa.by_type_fy;
            } else {
                chartData = pa.by_state_type_fy?.[selectedPipelineState] || [];
            }

            // Filter out Unknown and empty FYs for cleaner chart
            const filteredData = chartData.filter(d => d.fy !== 'Unknown' && d.total > 0);
            
            // If no data with known FYs, include Unknown
            if (filteredData.length === 0) {
                const unknownData = chartData.find(d => d.fy === 'Unknown');
                if (unknownData && unknownData.total > 0) {
                    filteredData.push(unknownData);
                }
            }

            // Labels (fiscal years)
            const labels = filteredData.map(d => d.fy);
            
            // Stacked bar datasets for each project type (4 categories)
            const projectTypes = pa.project_types || ['Bridge', 'Pavement', 'Safety', 'Other'];
            const barDatasets = projectTypes.map(type => ({
                label: type,
                data: filteredData.map(d => d[type] || 0),
                backgroundColor: TYPE_COLORS[type] || '#888',
                borderRadius: 4,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }));

            // Line dataset for YoY %
            const yoyData = filteredData.map(d => d.yoy_pct);
            const lineDataset = {
                label: 'YoY Change %',
                data: yoyData,
                type: 'line',
                borderColor: '#fff',
                backgroundColor: 'rgba(255,255,255,0.1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: yoyData.map(v => v === null ? 'transparent' : (v >= 0 ? '#50c878' : '#ff6b6b')),
                pointBorderColor: '#fff',
                tension: 0.3,
                yAxisID: 'yoy',
                order: 0
            };

            // Calculate totals for each bar (for data labels)
            const barTotals = filteredData.map(d => d.total || 0);

            // Destroy existing chart
            if (pipelineChart) {
                pipelineChart.destroy();
            }

            // Register datalabels plugin
            Chart.register(ChartDataLabels);

            // Create new chart
            const ctx = document.getElementById('pipelineChart').getContext('2d');
            pipelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [...barDatasets, lineDataset]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false  // We have custom legend
                        },
                        datalabels: {
                            // Show total value on top of stacked bars
                            display: function(context) {
                                // Only show on the last (topmost) bar dataset, not on line
                                const datasetIndex = context.datasetIndex;
                                const datasetsCount = context.chart.data.datasets.length;
                                // Last bar dataset is second to last (line is last)
                                return datasetIndex === datasetsCount - 2;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            color: '#4da6ff',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                // Sum all bar values for this index
                                const index = context.dataIndex;
                                let total = 0;
                                context.chart.data.datasets.forEach((dataset, i) => {
                                    // Skip the line dataset (YoY)
                                    if (dataset.type !== 'line' && dataset.data[index]) {
                                        total += dataset.data[index];
                                    }
                                });
                                return formatCurrencyShort(total);
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 42, 58, 0.95)',
                            titleColor: '#4da6ff',
                            bodyColor: '#e0e0e0',
                            borderColor: 'rgba(77, 166, 255, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'YoY Change %') {
                                        const val = context.raw;
                                        return val !== null ? `YoY: ${val >= 0 ? '+' : ''}${val}%` : '';
                                    }
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                },
                                afterBody: function(tooltipItems) {
                                    // Add total to tooltip
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        if (item.dataset.type !== 'line') {
                                            total += item.raw || 0;
                                        }
                                    });
                                    return [`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`, `Total: ${formatCurrency(total)}`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888' }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#888',
                                callback: value => formatCurrencyShort(value)
                            },
                            title: {
                                display: true,
                                text: 'Pipeline Value',
                                color: '#888'
                            }
                        },
                        yoy: {
                            position: 'right',
                            grid: { display: false },
                            ticks: {
                                color: '#888',
                                callback: value => value + '%'
                            },
                            title: {
                                display: true,
                                text: 'YoY %',
                                color: '#888'
                            }
                        }
                    }
                }
            });

            // Update summary sidebar
            updatePipelineSummary(pa, selectedPipelineState);
        }

        function updatePipelineSummary(pa, state) {
            // Get totals by type
            let byType;
            if (state === 'all') {
                byType = pa.by_type;
            } else {
                byType = pa.by_state_type?.[state] || {};
            }

            const projectTypes = pa.project_types || ['Bridge', 'Pavement', 'Safety', 'Other'];
            const total = Object.values(byType).reduce((sum, t) => sum + (t.value || 0), 0);
            
            // Get forward pipeline (current FY + future)
            const forwardPipeline = pa.forward_pipeline || total;
            const currentFY = pa.current_fy || new Date().getFullYear();

            // Render type breakdown
            const summaryHtml = projectTypes.map(type => {
                const data = byType[type] || { count: 0, value: 0 };
                const pct = total > 0 ? Math.round(data.value / total * 100) : 0;
                return `<div class="type-row">
                    <div class="type-label">
                        <span class="type-color" style="background: ${TYPE_COLORS[type]}"></span>
                        ${type}
                    </div>
                    <div class="type-value">
                        ${formatCurrencyShort(data.value)}
                        <span class="type-pct">(${pct}%)</span>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('pipelineTypeSummary').innerHTML = summaryHtml;
            document.querySelector('#pipelineTotalDisplay .value').textContent = formatCurrency(total);
        }

        function formatCurrencyShort(value) {
            if (!value || value === 0) return '$0';
            if (value >= 1e9) return '$' + (value / 1e9).toFixed(1) + 'B';
            if (value >= 1e6) return '$' + (value / 1e6).toFixed(0) + 'M';
            if (value >= 1e3) return '$' + (value / 1e3).toFixed(0) + 'K';
            return '$' + value.toFixed(0);
        }

        function renderFeeds(data) {
            // Filter by selected state
            const filterByState = (items) => {
                if (selectedState === 'all') return items;
                return items.filter(item => item.state === selectedState);
            };

            // DOT Lettings
            const filteredDot = filterByState(data.dot_lettings || []);
            const dotHtml = filteredDot.map(d => {
                const typeClass = getProjectTypeClass(d.project_type);
                const location = d.location || d.state;
                const projectType = d.project_type ? `<span class="project-type ${typeClass}">${d.project_type}</span>` : '';
                const adDate = d.ad_date ? `<span>üìÖ Ad: ${new Date(d.ad_date).toLocaleDateString()}</span>` : '';
                const district = d.district ? `<span>üèõÔ∏è District ${d.district}</span>` : '';
                const projectId = d.project_id ? `<span>üìã #${d.project_id}</span>` : '';
                
                return `<div class="project-card">
                    <div class="project-header">
                        <div class="project-location">${d.state} - ${location}</div>
                        <div class="project-value">${d.cost_display || 'See Portal'}</div>
                    </div>
                    <div class="project-name">${projectType}${d.description}</div>
                    <div class="project-meta">${district}${adDate}${projectId}</div>
                    <a href="${d.url}" target="_blank" class="project-link">View on ${d.source} ‚Üí</a>
                </div>`;
            }).join('') || `<p style="color:#666">No DOT lettings found${selectedState !== 'all' ? ' for ' + selectedState : ''}</p>`;
            document.getElementById('dot-content').innerHTML = dotHtml;

            // News
            const filteredNews = filterByState((data.news || []).filter(n => n.category === 'news'));
            document.getElementById('news-content').innerHTML = filteredNews.map(n =>
                `<div class="news-card">
                    <div class="news-source">${n.source} (${n.state}) ‚Ä¢ ${n.date}</div>
                    <div class="news-title"><a href="${n.url}" target="_blank" style="color:#e0e0e0;text-decoration:none">${n.title}</a></div>
                    <div class="news-summary">${n.summary || ''}</div>
                </div>`
            ).join('') || `<p style="color:#666">No news items found${selectedState !== 'all' ? ' for ' + selectedState : ''}</p>`;

            // Funding
            const filteredFunding = filterByState((data.news || []).filter(n => n.category === 'funding'));
            document.getElementById('funding-content').innerHTML = filteredFunding.map(n =>
                `<div class="news-card funding">
                    <div class="news-source">${n.source} (${n.state}) ‚Ä¢ ${n.date}</div>
                    <div class="news-title"><a href="${n.url}" target="_blank" style="color:#e0e0e0;text-decoration:none">${n.title}</a></div>
                    <div class="news-summary">${n.summary || ''}</div>
                </div>`
            ).join('') || `<p style="color:#666">No funding announcements found${selectedState !== 'all' ? ' for ' + selectedState : ''}</p>`;

            // All
            const allDot = filterByState(data.dot_lettings || []).map(d => ({...d, _type: 'dot'}));
            const allNews = filterByState(data.news || []).map(n => ({...n, _type: 'news'}));
            const allItems = [...allDot, ...allNews];
            document.getElementById('all-content').innerHTML = allItems.slice(0, 50).map(item => {
                if (item._type === 'dot') {
                    const typeClass = getProjectTypeClass(item.project_type);
                    const location = item.location || item.state;
                    const projectType = item.project_type ? `<span class="project-type ${typeClass}">${item.project_type}</span>` : '';
                    return `<div class="project-card">
                        <div class="project-header">
                            <div class="project-location">${item.state} - ${location}</div>
                            <div class="project-value">${item.cost_display || 'See Portal'}</div>
                        </div>
                        <div class="project-name">${projectType}${item.description}</div>
                        <a href="${item.url}" target="_blank" class="project-link">View on ${item.source} ‚Üí</a>
                    </div>`;
                } else {
                    return `<div class="news-card ${item.category === 'funding' ? 'funding' : ''}">
                        <div class="news-source">${item.source} (${item.state}) ‚Ä¢ ${item.date}</div>
                        <div class="news-title"><a href="${item.url}" target="_blank" style="color:#e0e0e0;text-decoration:none">${item.title}</a></div>
                    </div>`;
                }
            }).join('') || `<p style="color:#666">No items found${selectedState !== 'all' ? ' for ' + selectedState : ''}</p>`;
        }

        init();
    </script>
</body>
</html>
